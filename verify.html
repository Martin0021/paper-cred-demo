<!doctype html>
	<head>
		<link rel="stylesheet" href="style.v2.css">
		<title>Certificate Verifier</title>
	</head>
	<body>
        <div class="center2">
            <div class="full-div">
                <h3>Certificate Verifier <small>(<a href="https://github.com/Path-Check/paper-cred/">Spec</a>, <a href="https://vaccine-docs.pathcheck.org/">Main Page</a>, <a href="https://github.com/Path-Check/paper-cred-demo/">Source</a>)</small></small></h3>
            
                <div id="reader" style="margin-top: 10px;margin-bottom: 10px;"></div>
                <label for="verify">Or Paste the Code here:</label><br>
                <textarea id="qr-verify" rows="10" style="width:100%;" placeholder="cred:type:version:signature:pubkey:payload"></textarea>
                <br><br>
                <button class="qr-btn" onclick="verifyQRCode()">Verify</button>
                <br><br>
                <pre>Syntax: cred:<span class='protocol'>type:version</span>:<span class='signature'>signature</span>:<span class='pub-key'>pubkey</span>:<span class='message'>payload</span></pre>
                <pre id="qr-verify-result"></pre>
                <pre id="qr-verify-verified"></pre>
            </div>
        </div>
        
        <script src="js/qrcode.min.js"></script>
        
        <script src="js/elliptic.min.js"></script>
        <script src="js/sha256.js"></script>
        <script src="js/asn1.min.js"></script>
        <script src="js/base32.min.js"></script>
        <script src="js/html5-qrcode.min.js"></script>

        <script src="js/pcf.js"></script>

		<script>
            function e(elem) { return document.getElementById(elem); }

            function getValueArray(elemArray) {
                const fields = elemArray.map(function(elemId) {
                    return e(elemId).value;
                })
                return fields;
            }

            function verifySignature(pubkey, payload, signatureBase32NoPad, feedback_elem_id) {
                try {
                    const verified = PCF.verify(pubkey, payload, signatureBase32NoPad, feedback_elem_id)

                    e(feedback_elem_id).innerHTML = "Signature: " + (verified ? "Independently Verified" : "Not Valid");
                } catch(err) {
                    e(feedback_elem_id).innerHTML += "Signature Verification Failed: " + err;
                    console.error(err);
                }
            }

            function downloadAndVerify(pubkeyURL, payload, signatureBase32NoPad, feedback_elem_id) {
                let publicKeyPEM = PCF.getKeyId(pubkeyURL);

                if (publicKeyPEM !== null) {
                    verifySignature(publicKeyPEM, payload, signatureBase32NoPad, feedback_elem_id);
                } else {
                    e(feedback_elem_id).innerHTML += "Verification Failed: Public Key not found.";
                }
            }

            function describe(qr) {
                return qr.modules.size + "x" + qr.modules.size + " bits " + Math.round((qr.modules.size*qr.modules.size)/8) + " bytes ";
            }

            function verifyQRCode() {
                e("qr-verify-result").innerHTML = PCF.debugParseURI(e("qr-verify").value);
                e('qr-verify-verified').innerHTML = PCF.debugVerify(e("qr-verify").value);
            }

            function onScanSuccess(qrMessage) {
                e("qr-verify").value = qrMessage;
                verifyQRCode();
            }

            function onScanFailure(error) {
                console.warn(`QR error = ${error}`);
            }
        </script>
        
        <script>
            // Starting Scanner
            let html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 350 }, /* verbose= */ true);
            html5QrcodeScanner.render(onScanSuccess, onScanFailure);

            // Loading URI from qr parameter. 
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const qr = urlParams.get('qr')

            if (qr !== "" && qr != null) {
                const [schema, type, version, signatureBase32NoPad, pubKeyLink, payload] = PCF.parseURI(qr);
                decodedFields = payload.split('/');

                // Making sure the fields have not been decoded by the browser. 
                const encodedFields = decodedFields.map(function(field) {
                    return encodeURIComponent(field);
                })
                
                const decodedFieldsStr = encodedFields.join('/');

                e("qr-verify").value = [schema, type, version, signatureBase32NoPad, pubKeyLink, decodedFieldsStr].join(":")
                verifyQRCode();
            }
        </script>
	</body>
</html>


