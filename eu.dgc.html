<!doctype html>
	<head>
		<link rel="stylesheet" href="css/style.v2.css">
        <link rel="stylesheet" href="css/topnav.css">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="shortcut icon" href="https://www.pathcheck.org/hubfs/Favicon.png">
		<title>EU's Digital Green Certificate Payloads</title>
	</head>
	<body>
        <div class="topnav">
            <div class="topnavContainer">
              <a class="active" href="index.html">Signers</a>
              <a href="verify.html"><span class="xs-hidden">Universal </span>Verifier</a>
              <a class="xs-hidden" href="https://github.com/Path-Check/paper-cred-demo">Source Code</a>
              <a href="https://github.com/Path-Check/paper-cred"><span class="xs-hidden"> QR </span>Specs</a>
              <a href="http://vaccine-docs.pathcheck.org"><span class="xs-hidden">Vaccine </span>Docs</a>
              <a class="xs-hidden" href="http://pathcheck.org">About PathCheck</a>
            </div>
        </div>
      
        <div class="subnav">
            <div class="subnavContainer">
                <a href="index.v5.html">PCF<span class="xs-hidden">'s 4 QRs</span></a>
                <a class="active" href="eu.dgc.html">EU<span class="xs-hidden"> Green Pass</span></a>
                <a href="cowin.html">DIVOC<span class="xs-hidden">/India</span></a>
                <a href="liberty.html">IBM/NY<span class="xs-hidden"> Excelsior</span></a>
                <a href="opencerta.html"><span class="xs-hidden">Open</span>Certa</a>
                <a href="vial.html">Vial<span class="xs-hidden"> Label</span></a>
                <a href="us.ma.id.html"><span class="xs-hidden">Mass </span>ID</a>
                <a href="banknote.html">Cash<span class="xs-hidden"> Bills</span></a>
            </div>
        </div>

        <div class="center">
            <h1>EU's Digital Green Certificate Payloads</h1>
            <div class="full-div">
                <div class="third">
                    <h4>Immunization</h4>
                    <table>
                        <tr><td>Name</td><td><input id="qr-vax-nam" type="text" placeholder=""/></td></tr>
                        <tr><td>DoB</td><td><input id="qr-vax-dob" type="text" placeholder=""/></td></tr>
                        <tr><td>Disease</td><td><input id="qr-vax-tg" type="text" placeholder=""/></td></tr>
                        <tr><td>Prophylaxis</td><td><input id="qr-vax-vp" type="text" placeholder=""/></td></tr>
                        <tr><td>Product</td><td><input id="qr-vax-mp" type="text" placeholder=""/></td></tr>
                        <tr><td>Manuf</td><td><input id="qr-vax-ma" type="text" placeholder=""/></td></tr>
                        <tr><td>Dose #</td><td><input id="qr-vax-dn" type="text" placeholder=""/></td></tr>
                        <tr><td>Doses</td><td><input id="qr-vax-sd" type="text" placeholder=""/></td></tr>
                        <tr><td>Date</td><td><input id="qr-vax-dt" type="text" placeholder=""/></td></tr>
                        <tr><td>Country</td><td><input id="qr-vax-co" type="text" placeholder=""/></td></tr>
                        <tr><td>Issuer</td><td><input id="qr-vax-is" type="text" placeholder=""/></td></tr>
                        <tr><td>Cert ID</td><td><input id="qr-vax-ci" type="text" placeholder=""/></td></tr>
                    </table>
                </div>
                <div class="third"> 
                    <h4>COVID Test</h4>
                    <table>
                        <tr><td>Name</td><td><input id="qr-test-nam" type="text" placeholder=""/></td></tr>
                        <tr><td>DoB</td><td><input id="qr-test-dob" type="text" placeholder=""/></td></tr>
                        <tr><td>Disease</td><td><input id="qr-test-tg" type="text" placeholder=""/></td></tr>
                        <tr><td>Type</td><td><input id="qr-test-tt" type="text" placeholder=""/></td></tr>
                        <tr><td>Test Name</td><td><input id="qr-test-nm" type="text" placeholder=""/></td></tr>
                        <tr><td>Manuf</td><td><input id="qr-test-ma" type="text" placeholder=""/></td></tr>
                        <tr><td>Date Colect</td><td><input id="qr-test-sc" type="text" placeholder=""/></td></tr>
                        <tr><td>Date Result</td><td><input id="qr-test-dr" type="text" placeholder=""/></td></tr>
                        <tr><td>Result</td><td><input id="qr-test-tr" type="text" placeholder=""/></td></tr>
                        <tr><td>Centre</td><td><input id="qr-test-tc" type="text" placeholder=""/></td></tr>
                        <tr><td>Country</td><td><input id="qr-test-co" type="text" placeholder=""/></td></tr>
                        <tr><td>Issuer</td><td><input id="qr-test-is" type="text" placeholder=""/></td></tr>
                        <tr><td>Cert ID</td><td><input id="qr-test-ci" type="text" placeholder=""/></td></tr>
                    </table>
                </div>
                <div class="third">
                    <h4>Recovery</h4>
                    <table>
                        <tr><td>Name</td><td><input id="qr-recov-nam" type="text" placeholder=""/></td></tr>
                        <tr><td>DoB</td><td><input id="qr-recov-dob" type="text" placeholder=""/></td></tr>
                        <tr><td>Disease</td><td><input id="qr-recov-tg" type="text" placeholder=""/></td></tr>
                        <tr><td>Date 1st Pos</td><td><input id="qr-recov-fr" type="text" placeholder=""/></td></tr>
                        <tr><td>Valid From</td><td><input id="qr-recov-df" type="text" placeholder=""/></td></tr>
                        <tr><td>Valid Until</td><td><input id="qr-recov-du" type="text" placeholder=""/></td></tr>
                        <tr><td>Country</td><td><input id="qr-recov-co" type="text" placeholder=""/></td></tr>
                        <tr><td>Issuer</td><td><input id="qr-recov-is" type="text" placeholder=""/></td></tr>
                        <tr><td>Cert ID</td><td><input id="qr-recov-ci" type="text" placeholder=""/></td></tr>
                    </table>
                </div>
                
                <div class="quarter">
                    <h4>Credentials</h4>
                    <label for="privkey">Private Key</label><br/>
<textarea id="privkey" rows="10" style="width: 100%;">-----BEGIN EC PARAMETERS-----
BgUrgQQACg==
-----END EC PARAMETERS-----
-----BEGIN EC PRIVATE KEY-----
MHQCAQEEIPWKbSezZMY1gCpvN42yaVv76Lo47FvSsVZpQl0a5lWRoAcGBSuBBAAK
oUQDQgAE6DeIun4EgMBLUmbtjQw7DilMJ82YIvOR2jz/IK0R/F7/zXY1z+gqvFXf
DcJqR5clbAYlO9lHmvb4lsPLZHjugQ==
-----END EC PRIVATE KEY-----</textarea>
                    <br><br>
                    <label for="pubkey">Public Key</label><br/>
                    <textarea id="qr-link" rows="1" cols="30">1A9.PCF</textarea>
                </div>
            </div>
            <br>
            <div class="four-quarter">
                <button class="qr-btn" onclick="generateQRCodes()">Create Certificates</button>
            </div>
            <div class="full-div">
                <div class="third">
                    <h4 id="qr-vax-code-label" style="display: none;">Immunization QR</h4>
                    <canvas id="qr-vax-code"></canvas><br/>
                    <h4 id="qr-vax-pdf-label" style="display: none;">PDF 417 Format</h4>
                    <canvas id="qr-vax-pdf"></canvas><br/>
                    <pre id="qr-vax-result"></pre>
                    <pre id="qr-vax-verified"></pre>
                    <pre id="qr-vax-bytes" class="xs-hidden"></pre>
                </div>
                <div class="third">
                    <h4 id="qr-test-code-label" style="display: none;">Test QR</h4>
                    <canvas id="qr-test-code"></canvas><br/>
                    <h4 id="qr-test-pdf-label" style="display: none;">PDF 417 Format</h4>
                    <canvas id="qr-test-pdf"></canvas><br/>
                    <pre id="qr-test-result"></pre>
                    <pre id="qr-test-verified"></pre>
                    <pre id="qr-test-bytes" class="xs-hidden"></pre>
                </div>
                <div class="third">
                    <h4 id="qr-recov-code-label" style="display: none;">Recovery QR</h4>
                    <canvas id="qr-recov-code"></canvas><br/>
                    <h4 id="qr-recov-pdf-label" style="display: none;">PDF 417 Format</h4>
                    <canvas id="qr-recov-pdf"></canvas><br/>
                    <pre id="qr-recov-result"></pre>
                    <pre id="qr-recov-verified"></pre>
                    <pre id="qr-recov-bytes" class="xs-hidden"></pre>
                </div>

                <div class="quarter xs-hidden">
                    <label for="verify">Verify a QR Code</label>
                    <textarea id="qr-verify" rows="10" cols="33" placeholder="cred:type:version:signature:pubkey:payload"></textarea>
                    <br><br>
                    <button class="qr-btn" onclick="verifyQRCode()">Verify</button>
                    <br><br>
                    <pre id="qr-verify-result"></pre>
                    <pre id="qr-verify-verified"></pre>
                </div>
            </div>
        </div>
        
        <script src="js/qrcode.min.js"></script>
        
        <script src="js/elliptic.min.js"></script>
        <script src="js/sha256.js"></script>
        <script src="js/asn1.min.js"></script>
        <script src="js/base32.min.js"></script>

        <script src="js/libbcmath.js" type="text/javascript"></script>
        <script src="js/bcmath.js" type="text/javascript"></script>
        <script src="js/pdf417.js" type="text/javascript"></script>

        <script src="js/pcf.js"></script>

		<script>
            function e(elem) { return document.getElementById(elem); }

            function getValueArray(elemArray) {
                const fields = elemArray.map(function(elemId) {
                    return e(elemId).value;
                })
                return fields;
            }

            function clearQR(elemPrefix) {
                e(elemPrefix+'-code').getContext('2d').clearRect(0, 0, e(elemPrefix+'-code').width, e(elemPrefix+'-code').height);
                e(elemPrefix+'-result').innerHTML = "";
                e(elemPrefix+'-verified').innerHTML = "";
                e(elemPrefix+'-bytes').innerHTML = "";
            }

            async function clear() {
                clearQR('qr-vax');
                clearQR('qr-test');
                clearQR('qr-recov');
            }

            function signAndDisplayQR(elemPref, _type, _version, priKeyPEM, pubKeyId, payloadValueArray) {
                const uri = PCF.sign(_type, _version, priKeyPEM, pubKeyId, payloadValueArray);
                const [schema, type, version, signature, pubKeyLink, payload] = PCF.parseURI(uri);

                const params = { margin:0, width:e(elemPref+'-code').scrollWidth, errorCorrectionLevel: 'L', color: {dark: '#3654DD' }};

                // Builds QR Element
                QRCode.toCanvas(e(elemPref+'-code'), uri, params, function (error) {
                })

                PDF417.draw(uri, e(elemPref+"-pdf"), 4, 1, 2);

                e(elemPref+"-code-label").style.display = '';
                e(elemPref+"-pdf-label").style.display = '';

                // Updates screen elements. 
                e(elemPref+"-result").innerHTML= 
                                            "<a href='https://github.com/Path-Check/paper-cred'><span class='schema'>" + schema + "</span></a>:" + 
                                            "<a href='https://github.com/Path-Check/paper-cred/blob/main/payloads/"+type.toLowerCase()+"."+version+".md'><span class='protocol'>"+type+":"+version+"</span></a>:" + 
                                            "<span class='signature'>" + signature + "</span>" + ":" +
                                            "<span class='pub-key'>" + pubKeyLink + "</span>" + ":" +
                                            "<span class='message'>" + payload + "</span><br>";
                //                            "Signature DER: <span class='signature'>" + signatureDER + "</span><br><br>"+
                //                            "Payload SHA256 Hash: <span class='message'>" + payloadSHA256 + "</span><br><br>";
                
                e(elemPref+"-result").innerHTML +=
                    "<pre>CRED:<span class='protocol'>TYPE:VERSION</span>:<span class='signature'>SIGNATURE</span>:" +
                    "<span class='pub-key'>KEYID</span>:<span class='message'>PAYLOAD</span></pre>"
                    
                
                e(elemPref+"-verified").innerHTML = "Signature: Not Verified";
                
                //e(elemPref+"-bytes").innerHTML = "QR Size: "+ Math.round((uri.length / 2) * 11/8) + " bytes";

                let qr = QRCode.create(uri, params);

                let qrQ = QRCode.create(uri, { margin:0, width:275, errorCorrectionLevel: 'Q', color: {dark: '#3654DD' }});
                let qrH = QRCode.create(uri, { margin:0, width:275, errorCorrectionLevel: 'H', color: {dark: '#3654DD' }});
                let qrM = QRCode.create(uri, { margin:0, width:275, errorCorrectionLevel: 'M', color: {dark: '#3654DD' }});
                let qrL = QRCode.create(uri, { margin:0, width:275, errorCorrectionLevel: 'L', color: {dark: '#3654DD' }});

                e(elemPref+"-bytes").innerHTML = "URI Size (A/N): "+ Math.round(uri.length * 5.5/8) + " bytes<br>";

                e(elemPref+"-bytes").innerHTML += "<br>QR Size Analysis: ";
                e(elemPref+"-bytes").innerHTML += "<br>-ECC L  7% "  + describe(qrL);
                e(elemPref+"-bytes").innerHTML += "<br>-ECC M 15% " + describe(qrM);
                e(elemPref+"-bytes").innerHTML += "<br>-ECC Q 25% " + describe(qrQ);
                e(elemPref+"-bytes").innerHTML += "<br>-ECC H 30% " + describe(qrH);
                
                e(elemPref+"-bytes").innerHTML += "<br><br>QR built with " + qr.segments.length + " segments";
                for (i=0; i<qr.segments.length; i++) {
                    e(elemPref+"-bytes").innerHTML += "<br>- " + i + ": " + qr.segments[i].mode.id + " " + qr.segments[i].data;
                }
                
                e(elemPref + "-verified").innerHTML = PCF.debugDownloadVerify(pubKeyLink, payload, signature);
            }

            function describe(qr) {
                return qr.modules.size + "x" + qr.modules.size + " " + Math.round((qr.modules.size*qr.modules.size)/8) + " bytes ";
            }

            function generateQRCodes() {
                clear();

                // Where to Download the public key
                const pubKeyLink = e("qr-link").value.trim().replace("http://","");

                // PEM code of the private key
                const priKeyPEM = e('privkey').value;

                const vaccineArray = getValueArray(["qr-vax-nam", "qr-vax-dob", "qr-vax-tg", "qr-vax-vp", "qr-vax-mp", "qr-vax-ma", "qr-vax-dn", "qr-vax-sd", "qr-vax-dt", "qr-vax-co", "qr-vax-is", "qr-vax-ci"]);
                signAndDisplayQR("qr-vax", "eu.dgc.vax","1", priKeyPEM, pubKeyLink, vaccineArray);

                const testArray = getValueArray(["qr-test-nam", "qr-test-dob", "qr-test-tg", "qr-test-tt", "qr-test-nm", "qr-test-ma", "qr-test-sc", "qr-test-dr", "qr-test-tr", "qr-test-tc", "qr-test-co", "qr-test-is", "qr-test-ci"]);  
                signAndDisplayQR("qr-test", "eu.dgc.test","1", priKeyPEM, pubKeyLink, testArray);

                const recoveryArray = getValueArray(["qr-recov-nam", "qr-recov-dob", "qr-recov-tg", "qr-recov-fr", "qr-recov-df", "qr-recov-du", "qr-recov-co", "qr-recov-is", "qr-recov-ci"]);
                signAndDisplayQR("qr-recov", "eu.dgc.recv","1", priKeyPEM, pubKeyLink, recoveryArray);

            }
            
            function verifyQRCode() {
                e("qr-verify-result").innerHTML = PCF.debugParseURI(e("qr-verify").value);
                e('qr-verify-verified').innerHTML = PCF.debugVerify(e("qr-verify").value);
            }
        </script>
        
        <script>
            function loadDemo() {
                e("qr-vax-nam").value = "John Doe";
                e("qr-vax-dob").value = "1982-01-01";
                e("qr-vax-tg").value = "840539006";
                e("qr-vax-vp").value = "1119349007";
                e("qr-vax-mp").value = "EU/1/20/1507";
                e("qr-vax-ma").value = "ORG-100031184";
                e("qr-vax-dn").value = "1";
                e("qr-vax-sd").value = "2";
                e("qr-vax-dt").value = new Date().toJSON().slice(0, 10);
                e("qr-vax-co").value = "GB";
                e("qr-vax-is").value = "GB Issuer";
                e("qr-vax-ci").value = "SOME-UNIQUE-ID";

                e("qr-test-nam").value = "John Doe";
                e("qr-test-dob").value = "1982-01-01";
                e("qr-test-tg").value = "840539006";
                e("qr-test-tt").value = "LP6464-4";
                e("qr-test-nm").value = "COVID PCR";
                e("qr-test-ma").value = "1232";
                e("qr-test-sc").value = "2021-04-20";
                e("qr-test-dr").value = "2021-04-22";
                e("qr-test-tr").value = "260373001";
                e("qr-test-tc").value = "Test Center";
                e("qr-test-co").value = "GB";
                e("qr-test-is").value = "GB Issuer";
                e("qr-test-ci").value = "SOME-UNIQUE-ID";

                e("qr-recov-nam").value = "John Doe";
                e("qr-recov-dob").value = "1982-01-01";
                e("qr-recov-tg").value = "840539006";
                e("qr-recov-fr").value = "2021-04-22";
                e("qr-recov-df").value = "2021-04-20";
                e("qr-recov-du").value = "2021-10-20";
                e("qr-recov-co").value = "GB";
                e("qr-recov-is").value = "GB Issuer";
                e("qr-recov-ci").value = "SOME-UNIQUE-ID";
            }

            loadDemo();
        </script>

        <script>
            async function preloadKey() {
                PCF.getKeyId(e("qr-link").value);
            }
            window.onload = function() {
                preloadKey();
            }
        </script>
	</body>
</html>


